#!/bin/bash
for POSTINST in %{_prefix}/lib/dkms/common.postinst %{_datarootdir}/%{module_name}/postinst; do
        if [ -f $POSTINST ]; then
                $POSTINST %{module_name} %{version} %{_datarootdir}/%{module_name}

        # Backup netronome blacklist
        blacklist_file=/etc/modprobe.d/blacklist-netronome.conf

        if [ -e "$blacklist_file" ]; then
            cp "$blacklist_file" "$blacklist_file".corenic.bak
        fi

        # Enable start script
        systemctl enable ns-core-nic.service

        # Clear any old config
        /opt/netronome/bin/ns-core-nic-setup clean

        # Generate new config
        /opt/netronome/bin/ns-core-nic-setup force

        # Disable logging
        /opt/netronome/bin/ns-core-nic-setup log-disable

        /opt/netronome/bin/ns-core-nic-setup check-flash || :

                exit $?
        fi
        echo "WARNING: $POSTINST does not exist."
done
echo -e "ERROR: DKMS version is too old and %{module_name} was not"
echo -e "built with legacy DKMS support."
echo -e "You must either rebuild %{module_name} with legacy postinst"
echo -e "support or upgrade DKMS to a more current version."
exit 1
