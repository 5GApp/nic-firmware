From d6fef7d1ad1723e9b976c0e32ff934771f43c2dd Mon Sep 17 00:00:00 2001
From: Johan Moraal <johan.moraal@netronome.com>
Date: Thu, 18 Oct 2018 10:56:26 +0200
Subject: [PATCH 1/1] Added nfd_vf_cfg_base function

Signed-off-by: Johan Moraal <johan.moraal@netronome.com>
---
 me/blocks/vnic/shared/nfd_vf_cfg_iface.h | 55 ++++++++++++++++++++++++++++++++
 1 file changed, 55 insertions(+)

diff --git a/me/blocks/vnic/shared/nfd_vf_cfg_iface.h b/me/blocks/vnic/shared/nfd_vf_cfg_iface.h
index b7969686..9d8d48ca 100644
--- a/me/blocks/vnic/shared/nfd_vf_cfg_iface.h
+++ b/me/blocks/vnic/shared/nfd_vf_cfg_iface.h
@@ -35,5 +35,60 @@
 #include "nfd_vf_cfg_iface_abi2.h"
 #endif
 
+/**
+ * @param isl           PCIe island, in the range 0..3
+ *
+ * This function is not intended for use on the data plane as it is
+ * expensive to extract the pointer.  Supplying an isl not in the
+ * range 0..3 or for a PCIe island not in use with NFD is illegal.
+ * It is caught with a halt().
+ */
+__intrinsic __emem char *nfd_vf_cfg_base(unsigned int isl) {
+    __emem char *vf_cfg_base;
+    switch (isl) {
+    case 0:
+        #ifdef NFD_PCIE0_EMEM
+            vf_cfg_base = NFD_VF_CFG_BASE_LINK(0);
+        #else
+            goto err;
+        #endif
+        break;
+    case 1:
+        #ifdef NFD_PCIE1_EMEM
+            vf_cfg_base = NFD_VF_CFG_BASE_LINK(1);
+        #else
+            goto err;
+        #endif
+        break;
+    case 2:
+        #ifdef NFD_PCIE2_EMEM
+            vf_cfg_base = NFD_VF_CFG_BASE_LINK(2);
+        #else
+            goto err;
+        #endif
+        break;
+    case 3:
+        #ifdef NFD_PCIE3_EMEM
+            vf_cfg_base = NFD_VF_CFG_BASE_LINK(3);
+        #else
+            goto err;
+        #endif
+        break;
+    default:
+        goto err;
+        break;
+    };
+
+    return vf_cfg_base;
+
+err:
+    /* XXX we are halting on this error because it indicates a serious error
+     * the return won't actually execute, and 0 is as good as any other
+     * value.  0x809 == NFD_CFG_BAR_BASE_ISL_INVALID */
+    local_csr_write(local_csr_mailbox_0, 0x809);
+    local_csr_write(local_csr_mailbox_1, isl);
+    halt();
+    return 0;
+};
 
 #endif /* !_BLOCKS__SHARED_NFD_VF_CFG_IFACE_H_ */
-- 
2.14.1.windows.1

